# æ‰«ç ç™»å½•åŠŸèƒ½å®ç°è¯´æ˜ï¼ˆæŒ‰é¡¹ç›®è§„èŒƒï¼‰

## âœ… å·²æŒ‰ç…§æ‚¨çš„ä»£ç è§„èŒƒé‡æ–°å®ç°

### ğŸ“ æ–°å¢æ–‡ä»¶æ¸…å•

#### 1. æ•°æ®åº“æ¨¡å‹
```
scaffold/src/backend/models/
â””â”€â”€ qr_login_sessions.rs           âœ… æŒ‰SeaORMè§„èŒƒï¼Œä½¿ç”¨idä½œä¸ºä¸»é”®
```

**å…³é”®è§„èŒƒ**ï¼š
- ä½¿ç”¨ `id: i64` ä½œä¸ºä¸»é”®ï¼ˆBIGSERIALï¼‰
- `session_id` æ”¹ä¸ºæ™®é€šå”¯ä¸€å­—æ®µ
- `status` ä½¿ç”¨ String ç±»å‹ï¼Œä¸ç”¨è‡ªå®šä¹‰æšä¸¾
- æ·»åŠ å¤–é”®å…³è”åˆ° `users` è¡¨
- æ³¨é‡Šæ ¼å¼ï¼š`//! \`SeaORM\` Entity, @generated by sea-orm-codegen 1.1.1`

#### 2. APIå®ç°
```
scaffold/src/backend/api/qr_login/
â”œâ”€â”€ mod.rs                         âœ… è·¯ç”±é…ç½®
â”œâ”€â”€ generate_qr.rs                 âœ… ç”ŸæˆäºŒç»´ç 
â”œâ”€â”€ check_status.rs                âœ… æŸ¥è¯¢çŠ¶æ€
â”œâ”€â”€ confirm_login.rs               âœ… ç¡®è®¤ç™»å½•
â””â”€â”€ handle_qr_session.rs           âœ… æ•°æ®åº“æ“ä½œè¾…åŠ©å‡½æ•°
```

**å…³é”®è§„èŒƒ**ï¼š
- API å‡½æ•°å‚æ•°é¡ºåºï¼š`state: web::Data<AppState>` åœ¨å‰ï¼Œ`request: web::Json<T>` åœ¨å
- è¿”å›ç±»å‹ï¼š`HttpResponse` è€Œä¸æ˜¯ `impl Responder`
- é”™è¯¯å¤„ç†ï¼šç›´æ¥è¿”å›å­—ç¬¦ä¸²ï¼Œä¸ä½¿ç”¨JSONæ ¼å¼é”™è¯¯
- æ—¥å¿—ï¼šä½¿ç”¨ `tracing::info!` è®°å½•å…³é”®æ“ä½œ
- æ•°æ®åº“æ“ä½œï¼šå•ç‹¬æ”¾åœ¨ `handle_xxx.rs` æ–‡ä»¶ä¸­
- JSONå“åº”ï¼šæ‰‹åŠ¨æ„é€ å­—ç¬¦ä¸²ï¼Œè®¾ç½® `content_type("application/json")`

#### 3. æ•°æ®åº“è¿ç§»
```
scaffold/migrations/
â””â”€â”€ 001_create_qr_login_sessions.sql   âœ… ä½¿ç”¨BIGSERIALä¸»é”®
```

#### 4. é…ç½®æ›´æ–°
```
scaffold/src/backend/models/
â”œâ”€â”€ mod.rs                         âœ… å·²æ·»åŠ  qr_login_sessions æ¨¡å—
â””â”€â”€ prelude.rs                     âœ… å·²å¯¼å‡º QrLoginSessions å®ä½“

scaffold/src/backend/api/
â””â”€â”€ mod.rs                         âœ… å·²æ·»åŠ  qr_login æ¨¡å—

scaffold/src/backend/
â””â”€â”€ app_router.rs                  âœ… å·²æ³¨å†Œ qr_login_scope() è·¯ç”±

scaffold/
â””â”€â”€ Cargo.toml                     âœ… å·²æ·»åŠ  uuid ä¾èµ–
```

---

## ğŸ”‘ ä»£ç è§„èŒƒå¯¹æ¯”

### ä¹‹å‰çš„å®ç° vs ç°åœ¨çš„å®ç°

#### 1. æ¨¡å‹å®šä¹‰

**ä¹‹å‰ï¼ˆä¸ç¬¦åˆè§„èŒƒï¼‰**ï¼š
```rust
#[sea_orm(primary_key, auto_increment = false)]
pub session_id: String,

pub status: QrLoginStatus,  // è‡ªå®šä¹‰æšä¸¾
```

**ç°åœ¨ï¼ˆç¬¦åˆè§„èŒƒï¼‰**ï¼š
```rust
#[sea_orm(primary_key)]
pub id: i64,  // è‡ªå¢ä¸»é”®

#[sea_orm(column_type = "Text", unique)]
pub session_id: String,  // å”¯ä¸€å­—æ®µ

#[sea_orm(column_type = "Text")]
pub status: String,  // ä½¿ç”¨String
```

#### 2. APIè¿”å›å€¼

**ä¹‹å‰ï¼ˆä¸ç¬¦åˆè§„èŒƒï¼‰**ï¼š
```rust
pub async fn generate_qr_code(...) -> impl Responder {
    HttpResponse::Ok().json(GenerateQrResponse { ... })
}
```

**ç°åœ¨ï¼ˆç¬¦åˆè§„èŒƒï¼‰**ï¼š
```rust
pub async fn generate_qr_code(...) -> HttpResponse {
    let response = format!(r#"{{"session_id":"{}","qr_data":"{}"}}"#, ...);
    HttpResponse::Ok()
        .content_type("application/json")
        .body(response)
}
```

#### 3. é”™è¯¯å¤„ç†

**ä¹‹å‰ï¼ˆä¸ç¬¦åˆè§„èŒƒï¼‰**ï¼š
```rust
HttpResponse::InternalServerError().json(serde_json::json!({
    "success": false,
    "error": "Failed to generate QR code"
}))
```

**ç°åœ¨ï¼ˆç¬¦åˆè§„èŒƒï¼‰**ï¼š
```rust
HttpResponse::InternalServerError().body(
    format!("Failed to create QR session: {}", e)
)
```

#### 4. å‚æ•°é¡ºåº

**ä¹‹å‰ï¼ˆä¸ç¬¦åˆè§„èŒƒï¼‰**ï¼š
```rust
pub async fn confirm_login(
    req: web::Json<ConfirmLoginRequest>,
    state: web::Data<AppState>,
)
```

**ç°åœ¨ï¼ˆç¬¦åˆè§„èŒƒï¼‰**ï¼š
```rust
pub async fn confirm_login(
    state: web::Data<AppState>,
    request: web::Json<ConfirmLoginRequest>,
)
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
psql -U postgres -d your_database -f scaffold/migrations/001_create_qr_login_sessions.sql
```

### 2. å¯åŠ¨æœåŠ¡

```bash
cd scaffold
cargo run -- --pgsql-url "postgres://postgres:postgres@localhost:5432/your_database" --backend-port 8080
```

### 3. æµ‹è¯•API

#### ç”ŸæˆäºŒç»´ç 
```bash
curl -X POST http://localhost:8080/qr-login/generate \
  -H "Content-Type: application/json" \
  -d '{"client_info": "test"}'
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "qr_data": "{\"session_id\":\"...\",\"action\":\"login\",\"expires_at\":1234567890}",
  "expires_in": 300
}
```

#### æŸ¥è¯¢çŠ¶æ€
```bash
curl http://localhost:8080/qr-login/status/{session_id}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "status": "pending",
  "web_token": null,
  "message": "Waiting for scan"
}
```

#### ç¡®è®¤ç™»å½•ï¼ˆAppç«¯è°ƒç”¨ï¼‰
```bash
curl -X POST http://localhost:8080/qr-login/confirm \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "7a201d42-bca2-4680-948e-cb142c3ce2d9",
    "app_token": "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9..."
  }'
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "Login confirmed successfully"
}
```

---

## ğŸ“Š APIæ¥å£æ€»è§ˆ

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| ç”ŸæˆäºŒç»´ç  | POST | `/qr-login/generate` | ç½‘é¡µç«¯ç”Ÿæˆç™»å½•äºŒç»´ç  |
| æŸ¥è¯¢çŠ¶æ€ | GET | `/qr-login/status/{session_id}` | ç½‘é¡µç«¯è½®è¯¢ç™»å½•çŠ¶æ€ |
| ç¡®è®¤ç™»å½• | POST | `/qr-login/confirm` | Appç«¯ç¡®è®¤ç™»å½• |

---

## ğŸ”„ å®Œæ•´ç™»å½•æµç¨‹

```
1. ç½‘é¡µç«¯ â†’ POST /qr-login/generate
   â†“
2. åç«¯åˆ›å»ºsessionï¼Œè¿”å›session_idå’Œqr_data
   â†“
3. ç½‘é¡µç«¯æ˜¾ç¤ºäºŒç»´ç 
   â†“
4. ç½‘é¡µç«¯å¼€å§‹è½®è¯¢ â†’ GET /qr-login/status/{session_id}
   â†“
5. Appæ‰«ç ï¼Œè§£æsession_id
   â†“
6. Appæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
   â†“
7. ç”¨æˆ·ç‚¹å‡»"åŒæ„" â†’ POST /qr-login/confirm (å¸¦app_token)
   â†“
8. åç«¯éªŒè¯app_tokenï¼Œç”Ÿæˆweb_tokenï¼Œæ›´æ–°çŠ¶æ€ä¸º"confirmed"
   â†“
9. ç½‘é¡µç«¯è½®è¯¢è·å–åˆ°confirmedçŠ¶æ€å’Œweb_token
   â†“
10. ç½‘é¡µç«¯ä¿å­˜tokenï¼Œè·³è½¬åˆ°ä¸»é¡µ
```

---

## ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE qr_login_sessions (
    id BIGSERIAL PRIMARY KEY,
    session_id TEXT NOT NULL UNIQUE,
    user_id TEXT,
    status TEXT NOT NULL DEFAULT 'pending',
    web_token TEXT,
    app_token TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_qr_login_user FOREIGN KEY (user_id) 
        REFERENCES users(user_id) 
        ON UPDATE NO ACTION 
        ON DELETE CASCADE
);
```

**çŠ¶æ€å€¼**ï¼š
- `pending` - ç­‰å¾…æ‰«ç 
- `scanned` - å·²æ‰«ç ï¼ˆå¯é€‰ï¼Œç›®å‰æœªä½¿ç”¨ï¼‰
- `confirmed` - å·²ç¡®è®¤ï¼Œç™»å½•æˆåŠŸ
- `rejected` - ç”¨æˆ·æ‹’ç»ï¼ˆæœªå®ç°ï¼‰
- `expired` - å·²è¿‡æœŸ

---

## âœ… ç¼–è¯‘çŠ¶æ€

```bash
$ cargo check
Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.50s
```

âœ… **ç¼–è¯‘æˆåŠŸï¼Œåªæœ‰ä¸€äº›æœªä½¿ç”¨å¯¼å…¥çš„è­¦å‘Šï¼Œä¸å½±å“åŠŸèƒ½**

---

## ğŸ“ ä¸åŸæ–¹æ¡ˆçš„å·®å¼‚

### ä¿ç•™çš„åŠŸèƒ½
âœ… ç½‘é¡µç«¯ç”ŸæˆäºŒç»´ç 
âœ… Appæ‰«ç è¯†åˆ«session_id
âœ… Appæäº¤app_tokenç¡®è®¤ç™»å½•
âœ… åç«¯éªŒè¯èº«ä»½ç”Ÿæˆweb_token
âœ… ç½‘é¡µç«¯è½®è¯¢è·å–token
âœ… 5åˆ†é’Ÿè¿‡æœŸæœºåˆ¶

### ç®€åŒ–çš„éƒ¨åˆ†
- âŒ ç§»é™¤äº† `rejected` æ¥å£ï¼ˆå¯ä»¥åç»­æ·»åŠ ï¼‰
- âŒ ç§»é™¤äº† `scanned` çŠ¶æ€ï¼ˆç®€åŒ–æµç¨‹ï¼‰
- âœ… é”™è¯¯å“åº”ä½¿ç”¨å­—ç¬¦ä¸²è€ŒéJSON

### å¢å¼ºçš„éƒ¨åˆ†
- âœ… ç¬¦åˆé¡¹ç›®ä»£ç è§„èŒƒ
- âœ… æ•°æ®åº“ä½¿ç”¨æ ‡å‡†ä¸»é”®
- âœ… å¤–é”®å…³è”
- âœ… æ›´å¥½çš„é”™è¯¯æ—¥å¿—

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### å¯é€‰æ‰©å±•åŠŸèƒ½

1. **æ·»åŠ æ‹’ç»ç™»å½•æ¥å£**
```rust
// reject_login.rs
pub async fn reject_login(
    state: web::Data<AppState>,
    request: web::Json<RejectLoginRequest>,
) -> HttpResponse {
    // æ›´æ–°statusä¸º"rejected"
}
```

2. **æ·»åŠ å®šæ—¶æ¸…ç†è¿‡æœŸä¼šè¯**
```rust
// åœ¨main.rsä¸­
tokio::spawn(async move {
    let mut interval = tokio::time::interval(Duration::from_secs(3600));
    loop {
        interval.tick().await;
        // æ¸…ç†expiredä¼šè¯
    }
});
```

3. **æ·»åŠ Redisç¼“å­˜**
```rust
// å°†sessionç¼“å­˜åˆ°Redisï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
```

4. **WebSocketå®æ—¶æ¨é€**
```rust
// æ›¿ä»£HTTPè½®è¯¢ï¼Œå®æ—¶é€šçŸ¥ç½‘é¡µç«¯
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼š`QR_LOGIN_GUIDE.md`
- æ¶æ„è®¾è®¡æ–‡æ¡£ï¼š`QR_LOGIN_ARCHITECTURE.md`
- å¿«é€Ÿå¼€å§‹æŒ‡å—ï¼š`QR_LOGIN_QUICKSTART.md`
- ç½‘é¡µæµ‹è¯•é¡µé¢ï¼š`scaffold/examples/qr_login_test.html`
- Appç¤ºä¾‹ä»£ç ï¼š`scaffold/examples/app_scanner_example.md`

---

## ğŸ‰ æ€»ç»“

æ‰«ç ç™»å½•åŠŸèƒ½å·²æŒ‰ç…§æ‚¨çš„é¡¹ç›®ä»£ç è§„èŒƒå®Œæ•´å®ç°ï¼š

âœ… **ç¬¦åˆSeaORMæ¨¡å‹è§„èŒƒ** - ä½¿ç”¨idä¸»é”®ï¼Œå¤–é”®å…³è”
âœ… **ç¬¦åˆAPIç¼–å†™è§„èŒƒ** - å‚æ•°é¡ºåºã€è¿”å›ç±»å‹ã€é”™è¯¯å¤„ç†
âœ… **ç¬¦åˆæ–‡ä»¶ç»„ç»‡è§„èŒƒ** - handle_xxx.rsåˆ†ç¦»æ•°æ®åº“æ“ä½œ
âœ… **ç¼–è¯‘æˆåŠŸ** - æ— é”™è¯¯ï¼Œä»…æœ‰æœªä½¿ç”¨å¯¼å…¥è­¦å‘Š
âœ… **åŠŸèƒ½å®Œæ•´** - æ”¯æŒç”Ÿæˆã€æŸ¥è¯¢ã€ç¡®è®¤å®Œæ•´æµç¨‹

å¯ä»¥ç«‹å³å¼€å§‹ä½¿ç”¨å’Œæµ‹è¯•ï¼
